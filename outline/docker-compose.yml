version: '3.8'

services:

  outline:
    image: docker.getoutline.com/outlinewiki/outline:latest
    env_file: ../docker.env
    ports:
      - "3000:3000"
    volumes:
      - outline-data:/var/lib/outline/data
    depends_on:
      - postgres
      - redis
      - minio
    networks:
      - keycloak_outline-app
  redis:
    image: redis
    env_file: ../docker.env
    hostname: redis
    ports:
      - "6379:6379"
    volumes:
      - ./redis.conf:/redis.conf
    command: [ "redis-server", "/redis.conf" ]
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 30s
      retries: 3
    networks:
      - keycloak_outline-app

  postgres:
    image: postgres:13
    env_file: ../docker.env
    hostname: postgres
    ports:
      - "5432:5432"
    volumes:
      - database-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD", "pg_isready", "-d", "outline", "-U", "dattb" ]
      interval: 30s
      timeout: 20s
      retries: 3
    environment:
      POSTGRES_USER: 'dattb'
      POSTGRES_PASSWORD: 'dattb123'
      POSTGRES_DB: 'outline'
    networks:
      - keycloak_outline-app
  https-portal:
    image: steveltn/https-portal
    env_file: ../docker.env
    ports:
      - '80:80'
      - '443:443'
    links:
      - outline
    restart: always
    volumes:
      - https-portal-data:/var/lib/https-portal
    healthcheck:
      test: ["CMD", "service", "nginx", "status"]
      interval: 30s
      timeout: 20s
      retries: 3
    environment:
#      DOMAINS: 'dattb.info -> http://outline:3000'
      STAGE: 'production'
      WEBSOCKET: 'true'
      CLIENT_MAX_BODY_SIZE: '0'
    networks:
      - keycloak_outline-app
      
  minio:
    image: minio/minio:latest
    env_file: ../docker.env
    networks:
      - keycloak_outline-app
    ports:
      - "9000:9000"
      - "9001:9001"
    deploy:
      restart_policy:
        condition: on-failure
    volumes:
      - minio-data:/data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://minio:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3
    environment:
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123
    entrypoint: sh
    command: -c 'minio server --console-address ":9001" /data'

volumes:
  outline-data:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: 'C:\\Users\\HLC\\Documents\\docker-mount\\image-data\\outline\\outline-data'
  database-data:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: 'C:\\Users\\HLC\\Documents\\docker-mount\\image-data\\postgre'
  https-portal-data:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: 'C:\\Users\\HLC\\Documents\\docker-mount\\image-data\\outline\\nginx'
  minio-data:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: 'C:\\Users\\HLC\\Documents\\docker-mount\\image-data\\minio-data'

networks:
  keycloak_outline-app:
    external: true

#https://github.com/heyValdemar/outline-keycloak-traefik-letsencrypt-docker-compose
#https://wenkdth.org/posts/keycloak-outline-setup/
#https://medium.com/@ange.cesari/how-to-deploy-outline-wiki-fully-self-hosted-no-tls-with-docker-compose-e50b57baaf73